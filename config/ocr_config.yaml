# OCR Configuration - Smart Adaptive Mode
# Version: 3.0
#
# PHILOSOPHY: Let PaddleOCR do what it's built for.
# Our preprocessing only fixes what PaddleOCR cannot fix itself.

ocr:
  use_gpu: false
  use_angle_cls: true
  lang: 'en'

  # Detection thresholds
  # 0.15 is good for faint/low-quality receipts
  # Do NOT go below 0.1 — you'll get too many false detections
  det_db_thresh: 0.15
  det_db_box_thresh: 0.5

  # Unclip ratio: controls how much each detected text box is expanded
  # 1.5 is a balanced value — 1.2 cuts off edges, 2.0+ merges separate words
  det_db_unclip_ratio: 1.5

  # Recognition
  rec_batch_num: 6
  # drop_score: minimum confidence to keep a recognized text line
  # 0.3 is a good balance — lower values add noise, higher values miss faint text
  drop_score: 0.3
  use_space_char: true

  # Resolution: 2560px max side is enough for any real receipt photo
  # Going higher (3000+) adds processing time with little accuracy gain
  det_limit_side_len: 2560
  det_limit_type: 'max'

  # use_dilation: expands text regions slightly before detection
  # Helps catch thin/faint text strokes — leave on
  use_dilation: true

  # det_db_score_mode: 'slow' is more accurate for dense text like receipts
  det_db_score_mode: 'slow'

# Preprocessing — smart adaptive, per-condition targeting
preprocessing:
  # AUTO MODE: ImagePreprocessor v3 analyzes each image and only applies
  # what is actually needed. Set enhance_contrast: false so preprocess()
  # routes to the new smart path, not the old CLAHE-always path.
  enhance_contrast: false    # ← IMPORTANT: keep false, v3 handles this internally

  # These are thresholds used by ImagePreprocessor v3 analysis
  # (matching the constants in image_preprocessor.py)
  dark_mean_threshold: 80       # below → apply gamma correction
  very_dark_mean_threshold: 50  # below → apply stronger gamma
  low_contrast_threshold: 35    # std below → apply gentle CLAHE
  shadow_variance_threshold: 900

  # Deskew
  deskew_enabled: true
  skew_min_angle: 1.5           # degrees, below → skip deskew (avoid unnecessary rotation)

  # Size limits
  max_image_size: 4096
  min_image_size: 600
  target_resize: 2560

# Text enhancement (post-OCR spacing and character fixes)
text_enhancement:
  enabled: true
  restore_spacing: true
  restore_special_chars: true
  patterns:
    phone: true
    tin: true
    vat: true
    items: true

# Small-text OCR instance (used for confidence retry when avg bbox height < 15px)
# These params differ from the standard [ocr] section intentionally:
#   - Lower det_db_thresh (0.10 vs 0.15): more sensitive for faint thin strokes
#   - Lower det_db_unclip_ratio (1.2 vs 1.5): tighter boxes prevent line merging
#   - Lower det_db_box_thresh (0.4 vs 0.5): keep more borderline detections
#   - Higher det_limit_side_len (4096 vs 2560): more pixels = more detail
#   - Lower drop_score (0.20 vs 0.30): accept less-certain small text recognitions
ocr_small_text:
  det_db_thresh: 0.10
  det_db_unclip_ratio: 1.2
  det_db_box_thresh: 0.4
  det_limit_side_len: 4096
  drop_score: 0.20

# Small text preprocessor thresholds (used by ImagePreprocessor v3)
small_text:
  # If estimated text height is below this, upscale the image before OCR
  upscale_threshold_px: 20
  # Target longest side when upscaling for small text
  upscale_target_side: 2400
  # OCR confidence retry threshold (avg bbox height in pixels)
  retry_bbox_threshold_px: 15

# Performance
performance:
  use_multiprocessing: false
  max_workers: 4
  cache_preprocessed: false
  log_level: 'INFO'
  save_debug_images: false    # Set true temporarily when debugging quality issues

# Metadata extraction (used by GeneralMetadataExtractor v2)
metadata:
  # These are informational only — actual patterns are in general_metadata_extractor.py
  merchant_lines: 3